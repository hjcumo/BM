<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒë§¤ ë§ˆì§„ ê³„ì‚°ê¸° by M. G. H.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap');

        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #F8FAFC;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .number-input::-webkit-outer-spin-button,
        .number-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .number-input {
            -moz-appearance: textfield;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #F1F5F9;
        }

        .input-group label {
            color: #64748B;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .input-field,
        .select-field {
            border: 1px solid #E2E8F0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: all 0.2s;
            width: 100%;
            font-size: 0.95rem;
        }

        .input-field:focus,
        .select-field:focus {
            border-color: #6366F1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .sticky-summary {
            position: sticky;
            top: 2rem;
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            margin-top: 1rem;
            margin-bottom: 2rem;
        }

        .quantity-control-btn {
            background-color: #F1F5F9;
            color: #64748B;
            transition: all 0.2s;
        }

        .quantity-control-btn:hover {
            background-color: #E2E8F0;
            color: #334155;
        }

        .radio-label {
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #E2E8F0;
            transition: all 0.2s;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
        }

        .radio-label:hover {
            background-color: #F8FAFC;
        }

        input[type="radio"]:checked+.radio-label {
            background-color: #EEF2FF;
            border-color: #6366F1;
            color: #4F46E5;
            font-weight: 600;
        }

        input[type="radio"] {
            display: none;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #F1F5F9;
        }

        .result-row:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-slate-800">
                    <span class="mr-2">ğŸ“Š</span> íŒë§¤ ë§ˆì§„ ë¶„ì„ê¸°
                </h1>
                <p class="text-slate-500 mt-1 text-sm">ì‹¤ì‹œê°„ìœ¼ë¡œ ë§ˆì§„ìœ¨ì„ ì‹œë®¬ë ˆì´ì…˜ í•´ë³´ì„¸ìš”.</p>
            </div>
            <button onclick="window.print()"
                class="hidden md:flex items-center px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 transition">
                <span>ğŸ–¨ï¸ ì¸ì‡„/PDF ì €ì¥</span>
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- Left Column: Inputs (7/12) -->
            <div class="lg:col-span-7 space-y-6">

                <!-- 1. ê¸°ë³¸ íŒë§¤ ì„¤ì • -->
                <div class="card p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                        <span class="bg-indigo-100 text-indigo-600 p-2 rounded-lg mr-3 text-sm">1</span> íŒë§¤ ê¸°ë³¸ ì„¤ì •
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="input-group">
                            <label>íŒë§¤ ê°€ê²© (ì›)</label>
                            <input type="text" id="salePrice" placeholder="0"
                                class="number-input input-field text-lg font-bold text-indigo-600">
                        </div>
                        <div class="input-group">
                            <label>íŒë§¤ ì±„ë„ íƒ€ì… (ìˆ˜ìˆ˜ë£Œ)</label>
                            <div class="flex gap-2 text-sm">
                                <label>
                                    <input type="radio" name="salesType" value="business">
                                    <span class="radio-label">ì‚¬ì—…ì (3.7%)</span>
                                </label>
                                <label>
                                    <input type="radio" name="salesType" value="member">
                                    <span class="radio-label">íšŒì› (3.7%)</span>
                                </label>
                                <label>
                                    <input type="radio" name="salesType" value="general" checked>
                                    <span class="radio-label">ì¼ë°˜ (13%)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. ìƒí’ˆ ë§¤ì… êµ¬ì„± -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center">
                            <span class="bg-indigo-100 text-indigo-600 p-2 rounded-lg mr-3 text-sm">2</span> ìƒí’ˆ êµ¬ì„±
                        </h2>
                        <span id="totalPurchaseDisplay"
                            class="text-sm font-bold text-slate-600 bg-slate-100 px-3 py-1 rounded-full">ë§¤ì…í•©ê³„: 0ì›</span>
                    </div>

                    <div id="productLineContainer" class="space-y-4">
                        <!-- Product Item Template will be injected here -->
                    </div>

                    <button id="addInfoBtn" type="button"
                        class="mt-4 w-full py-3 border-2 border-dashed border-indigo-200 rounded-lg text-indigo-500 font-medium hover:bg-indigo-50 hover:border-indigo-300 transition flex items-center justify-center">
                        <span class="mr-2">ï¼‹</span> êµ¬ì„± ìƒí’ˆ ì¶”ê°€í•˜ê¸°
                    </button>
                    <input type="hidden" id="totalPurchasePrice">
                </div>

                <!-- 3. ë°°ì†¡ ë° ê¸°íƒ€ ë¹„ìš© -->
                <div class="card p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                        <span class="bg-indigo-100 text-indigo-600 p-2 rounded-lg mr-3 text-sm">3</span> ë°°ì†¡/í¬ì¥/ê´‘ê³  ë¹„ìš©
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="input-group">
                            <label>ê³ ê° ë¶€ë‹´ ë°°ì†¡ë¹„ ì„¤ì •</label>
                            <div class="flex gap-2 mb-3">
                                <label class="flex-1">
                                    <input type="radio" name="customerShippingType" value="free">
                                    <span class="radio-label justify-center">ë¬´ë£Œë°°ì†¡</span>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="customerShippingType" value="paid" checked>
                                    <span class="radio-label justify-center">ìœ ë£Œë°°ì†¡</span>
                                </label>
                            </div>
                            <div id="shippingCostInputArea" class="">
                                <select id="customerShippingAmount" class="select-field bg-slate-50">
                                    <option value="3000">3,000ì›</option>
                                    <option value="5000">5,000ì›</option>
                                </select>
                            </div>
                        </div>

                        <div class="input-group">
                            <label>ì¶œê³  ë°°ì†¡ë¹„ (íƒë°°ì‚¬ ê³„ì•½ë‹¨ê°€)</label>
                            <select id="outgoingShippingCost" class="select-field">
                                <option value="2250">ê·¹ì†Œ - 2,250ì›</option>
                                <option value="2350">ì†Œ1 - 2,350ì›</option>
                                <option value="2670">ì†Œ2 - 2,670ì›</option>
                                <option value="3200">ì¤‘ - 3,200ì›</option>
                                <option value="5000">ëŒ€í˜• - 5,000ì›</option>
                                <option value="5500">ì´í˜• - 5,500ì›</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="input-group">
                            <label>í¬ì¥ì¬ ë¹„ìš© (ë°•ìŠ¤/í…Œì´í”„ ë“±)</label>
                            <select id="packagingCostRate" class="select-field">
                                <option value="0.02">íŒë§¤ê°€ ëŒ€ë¹„ 2%</option>
                                <option value="0.03">íŒë§¤ê°€ ëŒ€ë¹„ 3%</option>
                                <option value="0.04">íŒë§¤ê°€ ëŒ€ë¹„ 4%</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>ê´‘ê³  ë§ˆì¼€íŒ…ë¹„</label>
                            <div class="flex items-center gap-2">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="adEnabled"
                                        class="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                        checked>
                                    <span class="text-sm text-slate-600">ì§‘í–‰í•¨</span>
                                </label>
                                <input type="number" id="advertisingRate" value="30"
                                    class="number-input input-field flex-1" placeholder="ì˜ˆ: 30">
                                <span class="text-slate-500 font-medium">%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Dashboard (5/12) -->
            <div class="lg:col-span-5">
                <div class="sticky-summary space-y-6">

                    <!-- Result Card -->
                    <div class="card p-6 border-indigo-100 shadow-xl ring-1 ring-indigo-50">
                        <h2 class="text-xl font-bold text-slate-800 mb-2">ìµœì¢… ë¶„ì„ ê²°ê³¼</h2>
                        <div id="marginResultBox"
                            class="text-center py-6 bg-slate-50 rounded-xl mb-6 transition-colors">
                            <p class="text-sm text-slate-500 mb-1">ìˆœìˆ˜ìµ (Net Profit)</p>
                            <div class="text-4xl font-black text-slate-800" id="finalMarginPrice">0ì›</div>
                            <div class="text-lg font-bold text-slate-500 mt-1" id="finalMarginPercent">0%</div>
                        </div>

                        <!-- Chart -->
                        <div class="chart-container">
                            <canvas id="costChart"></canvas>
                        </div>

                        <!-- Detail Table -->
                        <div class="space-y-2 text-sm text-slate-600 mt-4">
                            <!-- Revenue -->
                            <div class="result-row">
                                <span>(+) íŒë§¤ê°€</span>
                                <span class="font-bold text-slate-800" id="dispSalePrice">0ì›</span>
                            </div>
                            <div class="result-row">
                                <span>(+) ê³ ê° ë¶€ë‹´ ë°°ì†¡ë¹„</span>
                                <span class="font-bold text-slate-800" id="dispCustShip">0ì›</span>
                            </div>

                            <div class="my-3 border-t border-slate-200"></div>

                            <!-- Fees -->
                            <div class="result-row text-sm">
                                <span>(-) ì±„ë„ ìˆ˜ìˆ˜ë£Œ <span class="text-xs text-slate-400"
                                        id="dispChannelFeeRate"></span></span>
                                <span class="text-red-500" id="dispChannelFee">0ì›</span>
                            </div>
                            <div class="result-row text-sm">
                                <span>(-) ë°°ì†¡ë¹„ ìˆ˜ìˆ˜ë£Œ <span class="text-xs text-slate-400">(3.3%)</span></span>
                                <span class="text-red-500" id="dispShipFee">0ì›</span>
                            </div>

                            <div class="result-row bg-indigo-50 p-2 rounded-lg font-bold text-indigo-700 my-2">
                                <span>(=) ì •ì‚° ì˜ˆì •ê¸ˆì•¡</span>
                                <span id="settlementAmt">0ì›</span>
                            </div>

                            <!-- Deductions -->
                            <div class="result-row pt-2">
                                <span>(-) ìƒí’ˆ ë§¤ì… ì›ê°€</span>
                                <span class="text-red-500" id="totalPurchaseAmt">0ì›</span>
                            </div>
                            <div class="result-row">
                                <span>(-) ì¶œê³  ë°°ì†¡ë¹„ <span class="text-xs text-slate-400"
                                        id="dispOutShipName"></span></span>
                                <span class="text-red-500" id="dispOutShip">0ì›</span>
                            </div>
                            <div class="result-row">
                                <span>(-) í¬ì¥ë¹„ ë¹„ìš© <span class="text-xs text-slate-400" id="dispPkgRate"></span></span>
                                <span class="text-red-500" id="dispPkg">0ì›</span>
                            </div>
                            <div class="result-row">
                                <span>(-) ê´‘ê³  ë¹„ìš© <span class="text-xs text-slate-400" id="dispAdRate"></span></span>
                                <span class="text-red-500" id="totalAdAmt">0ì›</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="copyResults()"
                            class="card p-3 text-center hover:bg-slate-50 transition active:scale-95 text-sm font-bold text-slate-600">
                            ğŸ“‹ ê²°ê³¼ í…ìŠ¤íŠ¸ ë³µì‚¬
                        </button>
                        <button onclick="location.reload()"
                            class="card p-3 text-center hover:bg-slate-50 transition active:scale-95 text-sm font-bold text-slate-600">
                            ğŸ”„ ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <footer class="mt-12 mb-6 text-center">
        <p class="text-sm text-slate-400 font-medium tracking-wide">Created by H.MG</p>
    </footer>

    <!-- Template for Product Line -->
    <template id="productLineTemplate">
        <div class="product-line bg-slate-50 p-4 rounded-lg border border-slate-100 relative group animate-fade-in">
            <button type="button"
                class="del-btn absolute top-2 right-2 text-slate-400 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition">âœ•</button>
            <div class="grid grid-cols-12 gap-3 items-end">
                <div class="col-span-12 md:col-span-5">
                    <label class="block text-xs font-medium text-slate-500 mb-1">ìƒí’ˆëª…</label>
                    <input type="text" class="prod-name input-field text-sm" placeholder="ìƒí’ˆëª…">
                </div>
                <div class="col-span-5 md:col-span-3">
                    <label class="block text-xs font-medium text-slate-500 mb-1">ë‹¨ê°€</label>
                    <input type="text" class="prod-price number-input input-field text-sm text-right" placeholder="0">
                </div>
                <div class="col-span-4 md:col-span-2">
                    <label class="block text-xs font-medium text-slate-500 mb-1">ìˆ˜ëŸ‰</label>
                    <input type="number" class="prod-qty input-field text-sm text-center" value="1" min="1">
                </div>
                <div class="col-span-3 md:col-span-2 text-right pb-2">
                    <span class="prod-subtotal text-sm font-bold text-slate-700">0ì›</span>
                </div>
            </div>
        </div>
    </template>

    <script>
        // State
        let chartInstance = null;

        // Elements
        const salePriceInput = document.getElementById('salePrice');
        const productLineContainer = document.getElementById('productLineContainer');
        const template = document.getElementById('productLineTemplate');

        // --- Formatting Utils ---
        const formatNum = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const parseNum = (str) => parseInt(str.toString().replace(/,/g, '')) || 0;
        const formatCurrency = (n) => `${formatNum(Math.round(n))}ì›`;

        function handleNumberInput(e) {
            const val = parseNum(e.target.value);
            e.target.value = val === 0 ? '' : formatNum(val);
            calculate();
        }

        // --- Logic ---
        function addProductLine() {
            const clone = template.content.cloneNode(true);
            const div = clone.querySelector('.product-line');

            div.querySelector('.del-btn').addEventListener('click', () => {
                div.remove();
                calculate();
            });

            div.querySelector('.prod-price').addEventListener('input', handleNumberInput);
            div.querySelector('.prod-qty').addEventListener('input', calculate);
            div.querySelector('.prod-qty').addEventListener('change', calculate); // for spinner arrows

            productLineContainer.appendChild(clone);
        }

        function getFormData() {
            // 1. Sales Price
            const salePrice = parseNum(salePriceInput.value);

            // 2. Sales Type & Fee
            const salesType = document.querySelector('input[name="salesType"]:checked').value;
            let feeRate = 0.13;
            if (salesType === 'business' || salesType === 'member') feeRate = 0.037;
            const channelFee = salePrice * feeRate;

            // 3. Product Cost
            let totalPurchase = 0;
            document.querySelectorAll('.product-line').forEach(line => {
                const price = parseNum(line.querySelector('.prod-price').value);
                const qty = parseInt(line.querySelector('.prod-qty').value) || 0;
                const sub = price * qty;
                line.querySelector('.prod-subtotal').textContent = formatCurrency(sub);
                totalPurchase += sub;
            });
            document.getElementById('totalPurchaseDisplay').textContent = `ë§¤ì…í•©ê³„: ${formatCurrency(totalPurchase)}`;

            // 4. Shipping & Packaging
            const shippingType = document.querySelector('input[name="customerShippingType"]:checked').value;
            const customerShippingAmt = shippingType === 'paid' ? parseInt(document.getElementById('customerShippingAmount').value) : 0;
            const shippingFee = customerShippingAmt * 0.033; // 3.3% fee on shipping

            const outgoingShipping = parseInt(document.getElementById('outgoingShippingCost').value);
            const pkgRate = parseFloat(document.getElementById('packagingCostRate').value);
            const pkgCost = salePrice * pkgRate;

            // 5. Advertising
            const adEnabled = document.getElementById('adEnabled').checked;
            const adRate = adEnabled ? parseFloat(document.getElementById('advertisingRate').value) : 0;
            const adCost = salePrice * (adRate / 100);

            // Calculation
            // ì •ì‚°ê¸ˆì•¡ = (íŒë§¤ê°€ + ê³ ê°ë°°ì†¡ë¹„) - (ì±„ë„ìˆ˜ìˆ˜ë£Œ + ë°°ì†¡ë¹„ìˆ˜ìˆ˜ë£Œ)
            const settlement = (salePrice + customerShippingAmt) - (channelFee + shippingFee);

            // ìˆœìˆ˜ìµ = ì •ì‚°ê¸ˆì•¡ - (ë§¤ì…ê°€ + ì¶œê³ ë°°ì†¡ë¹„ + í¬ì¥ë¹„ + ê´‘ê³ ë¹„)
            const totalCost = totalPurchase + outgoingShipping + pkgCost + adCost;
            const margin = settlement - totalCost;
            const marginPercent = salePrice > 0 ? (margin / salePrice) * 100 : 0;

            return {
                salePrice, customerShippingAmt,
                totalPurchase,
                channelFee, shippingFee, feeRate,
                outgoingShipping, pkgCost, adCost,
                pkgRateDouble: pkgRate, adEnabled, adRate,
                settlement, margin, marginPercent,
                salesTypeText: document.querySelector('input[name="salesType"]:checked').nextElementSibling.innerText,
                outgoingShippingName: document.getElementById('outgoingShippingCost').options[document.getElementById('outgoingShippingCost').selectedIndex].text.split(' -')[0]
            };
        }

        function calculate() {
            const d = getFormData();

            // DOM Update
            document.getElementById('finalMarginPrice').textContent = formatCurrency(d.margin);
            document.getElementById('finalMarginPrice').className = `text-4xl font-black ${d.margin >= 0 ? 'text-indigo-600' : 'text-red-500'}`;
            document.getElementById('finalMarginPercent').textContent = `${d.marginPercent.toFixed(1)}%`;
            document.getElementById('finalMarginPercent').className = `text-lg font-bold mt-1 ${d.margin >= 0 ? 'text-indigo-400' : 'text-red-400'}`;

            // Background Alert styling
            const resBox = document.getElementById('marginResultBox');
            if (d.margin < 0) {
                resBox.classList.remove('bg-indigo-50', 'bg-slate-50');
                resBox.classList.add('bg-red-50');
            } else if (d.salePrice > 0) {
                resBox.classList.remove('bg-red-50', 'bg-slate-50');
                resBox.classList.add('bg-indigo-50');
            } else {
                resBox.classList.remove('bg-red-50', 'bg-indigo-50');
                resBox.classList.add('bg-slate-50');
            }

            document.getElementById('dispSalePrice').textContent = formatCurrency(d.salePrice);
            document.getElementById('dispCustShip').textContent = formatCurrency(d.customerShippingAmt);

            document.getElementById('dispChannelFeeRate').textContent = `(${(d.feeRate * 100).toFixed(1)}%)`;
            document.getElementById('dispChannelFee').textContent = `-${formatCurrency(d.channelFee)}`;
            document.getElementById('dispShipFee').textContent = `-${formatCurrency(d.shippingFee)}`;

            document.getElementById('settlementAmt').textContent = formatCurrency(d.settlement);

            document.getElementById('totalPurchaseAmt').textContent = `-${formatCurrency(d.totalPurchase)}`;

            document.getElementById('dispOutShipName').textContent = `(${d.outgoingShippingName})`;
            document.getElementById('dispOutShip').textContent = `-${formatCurrency(d.outgoingShipping)}`;

            document.getElementById('dispPkgRate').textContent = `(${(d.pkgRateDouble * 100).toFixed(0)}%)`;
            document.getElementById('dispPkg').textContent = `-${formatCurrency(d.pkgCost)}`;

            document.getElementById('dispAdRate').textContent = d.adEnabled ? `(${d.adRate}%)` : '';
            document.getElementById('totalAdAmt').textContent = `-${formatCurrency(d.adCost)}`;

            updateChart(d);
        }

        function updateChart(d) {
            // Chart Logic
            const ctx = document.getElementById('costChart').getContext('2d');

            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì°¨íŠ¸ ìˆ¨ê¸°ê¸° ë˜ëŠ” ë¹ˆ ìƒíƒœ
            if (d.salePrice === 0 && d.totalPurchase === 0) {
                if (chartInstance) {
                    chartInstance.data.datasets[0].data = [1];
                    chartInstance.data.labels = ['ì…ë ¥ ëŒ€ê¸°'];
                    chartInstance.data.datasets[0].backgroundColor = ['#E2E8F0'];
                    chartInstance.update();
                }
                return;
            }

            const dataValues = [
                Math.max(0, d.margin),
                d.totalPurchase,
                d.channelFee + d.shippingFee,
                d.outgoingShipping + d.pkgCost,
                d.adCost
            ];
            const labels = ['ìˆœìˆ˜ìµ', 'ìƒí’ˆë§¤ì…', 'ìˆ˜ìˆ˜ë£Œ', 'ë¬¼ë¥˜/í¬ì¥', 'ê´‘ê³ ë¹„'];
            const colors = ['#4F46E5', '#94A3B8', '#F59E0B', '#10B981', '#EF4444'];

            if (chartInstance) {
                chartInstance.data.datasets[0].data = dataValues;
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].backgroundColor = colors;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: dataValues,
                            backgroundColor: colors,
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { usePointStyle: true, boxWidth: 8, font: { size: 11 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += formatCurrency(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function copyResults() {
            const d = getFormData();
            const text = `
[ë§ˆì§„ ê³„ì‚° ê²°ê³¼ ìƒì„¸]
----------------------------
(+) íŒë§¤ê°€: ${formatCurrency(d.salePrice)}
(+) ê³ ê°ë¶€ë‹´ ë°°ì†¡ë¹„: ${formatCurrency(d.customerShippingAmt)}
----------------------------
(-) ì±„ë„ ìˆ˜ìˆ˜ë£Œ(${(d.feeRate * 100).toFixed(1)}%): ${formatCurrency(d.channelFee)}
(-) ë°°ì†¡ë¹„ ìˆ˜ìˆ˜ë£Œ(3.3%): ${formatCurrency(d.shippingFee)}
(=) ì •ì‚° ì˜ˆì •ê¸ˆì•¡: ${formatCurrency(d.settlement)}
----------------------------
(-) ìƒí’ˆ ë§¤ì…ê°€: ${formatCurrency(d.totalPurchase)}
(-) ì¶œê³  ë°°ì†¡ë¹„(${d.outgoingShippingName}): ${formatCurrency(d.outgoingShipping)}
(-) í¬ì¥ë¹„ ë¹„ìš©(${(d.pkgRateDouble * 100).toFixed(0)}%): ${formatCurrency(d.pkgCost)}
(-) ê´‘ê³  ë¹„ìš©${d.adEnabled ? `(${d.adRate}%)` : ''}: ${formatCurrency(d.adCost)}
----------------------------
[ìµœì¢… ê²°ê³¼]
âœ… ìˆœìˆ˜ìµ: ${formatCurrency(d.margin)}
ğŸ“ˆ ë§ˆì§„ìœ¨: ${d.marginPercent.toFixed(1)}%
            `.trim();
            navigator.clipboard.writeText(text).then(() => alert('ìƒì„¸ ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'));
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            // Add initial product line
            addProductLine();

            // Buttons
            document.getElementById('addInfoBtn').addEventListener('click', addProductLine);

            // Event Listeners for Global Form
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', calculate);
                input.addEventListener('change', calculate);
            });

            // Specifically handling the sales price formatting
            salePriceInput.addEventListener('input', handleNumberInput);

            // Handle shipping toggle
            document.querySelectorAll('input[name="customerShippingType"]').forEach(r => {
                r.addEventListener('change', (e) => {
                    document.getElementById('customerShippingAmountInputArea') // typo in HTML check?
                    const selectArea = document.getElementById('shippingCostInputArea');
                    if (e.target.value === 'free') selectArea.classList.add('hidden');
                    else selectArea.classList.remove('hidden');
                    calculate();
                });
            });

            // Handle Ad Toggle
            document.getElementById('adEnabled').addEventListener('change', (e) => {
                document.getElementById('advertisingRate').disabled = !e.target.checked;
                if (!e.target.checked) document.getElementById('advertisingRate').classList.add('bg-slate-100');
                else document.getElementById('advertisingRate').classList.remove('bg-slate-100');
                calculate();
            });

            // Initial chart init
            updateChart({ salePrice: 0, totalPurchase: 0 });
        });

    </script>
</body>

</html>
